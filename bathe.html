<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>야옹아목욕하자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'DosSammul';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_eight@1.0/DOSSaemmul.woff') format('woff');
      font-weight: normal;
      font-display: swap;
    }
    html{font-size:2rem;scroll-behavior:smooth;}
    body,h1,h2,h3,p,ol,ul{margin:0;padding:0;}
    h1{
      font-family:"Jersey 10",sans-serif;font-weight:400;font-size:4rem;text-align:center;
      padding:200px 0 20px 0;
      text-shadow:7px 7px 0 white,-7px -7px 0 white,7px -7px 0 white,-7px 7px 0 white;
      filter:drop-shadow(5px 5px 0 #73564b);
      z-index:999;position:relative;
    }
    h3{
      font-family:'DosSammul',sans-serif;font-weight:400;font-size:1rem;text-align:center;
      padding-bottom:70px;
      text-shadow:2px 2px 0 white,-2px -2px 0 white,2px -2px 0 white,-2px 2px 0 white;
      filter:drop-shadow(2px 2px 0 #73564b);z-index:999;position:relative;
    }
    .bg{background:url(bathroom_n.jpg) no-repeat center center fixed;background-size:cover;overflow-x:hidden;}
    #overlay{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:999;
    }
    #rulePopup{
      display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      width:610px;background:white;border:5px solid black;box-shadow:6px 6px 0 #333;
      padding:50px 30px;font-family:'DosSammul';line-height:1.3rem;font-size:0.7rem;color:black;z-index:1000;
    }
    #rulePopup h2{text-align:center;margin-bottom:60px;font-size:1.8rem;}
    #rulePopup ul{text-align:left;padding-left:20px;}
    #rulePopup button{
      display:block;margin:40px auto 0 auto;padding:15px 15px;border:3px solid black;background:white;
      font-family:'DosSammul';font-size:0.5rem;cursor:pointer;filter:drop-shadow(3px 3px 0 #555);
    }
    #rulePopup button:hover{background:black;color:white;}

    #bathStage{position:relative;width:100%;height:70vh;max-height:720px;margin:0 auto;z-index:10;}
    .clickable{position:absolute;cursor:pointer;image-rendering:pixelated;user-select:none;}

    #stepsPanel{
      position:fixed;top:50px;left:50px;z-index:900;
      font-family:'DosSammul',monospace;font-size:0.65rem;color:#222;image-rendering:pixelated;
    }

    #camBox{display:none;
      position:fixed;top:50px;left:300px;z-index:901;
      width:220px;padding:8px;background:rgba(255,255,255,.88);
      border:3px solid #333;box-shadow:4px 4px 0 #666;
      font-family:'DosSammul',monospace;font-size:12px;image-rendering:pixelated;
    }
    #camBox canvas{display:none;width:200px;height:150px;margin:0 auto;}
    #camBox .cap{margin-top:6px;text-align:center;}

    #bathTimer{
      position:fixed;top:40px;right:40px;z-index:802;
      font-family:"Jersey 10",sans-serif;font-size:2rem;
      text-shadow:3px 3px 0 white,-3px -3px 0 white,3px -3px 0 white,-3px 3px 0 white;
    }

    #catFace{ transform-origin:50% 20%; }
    @keyframes petPress {
      0%   { transform: translate(-50%, -50%) scaleY(1) translateY(0); }
      50%  { transform: translate(-50%, -50%) scaleY(0.94) translateY(3px); }
      100% { transform: translate(-50%, -50%) scaleY(1) translateY(0); }
    }
    
  </style>
</head>
<body class="bg">
  <h1 id="title">Bathe the Cat!</h1>
  <h3>야옹이의 외출 준비를 도와주세요!</h3>

  <div style="text-align:center;">
    <img src="dirtcat.png" id="startCat" style="width:420px;cursor:pointer;padding-top:30px">
  </div>

  <div id="overlay"></div>
  <div id="rulePopup"></div>

  <script>
    /* =========================
       전역 상태
    ========================= */
    let gameActive=false;
    let currentTool=null, ghostImg=null;
    let bubbleLayer=null;
    let steps=[], activeStepIndex=0;

    const MOTION_TH = 2;
    let motionActive = false;
    let lastBubbleAt = 0;
    const BUBBLE_COOLDOWN = 70;

    const WASH_CFG={
      soap:{goal:15000,gain:0.6},
      shampoo_g:{goal:11000,gain:0.65},
      shampoo_y:{goal:12000,gain:0.6},
      water:{goal:14000,gain:0.55},
      towel:{goal:10000,gain:0.5}
    };
    let washing={active:false, tool:null, progress:0, goal:0, gain:0.5};

    let bathTimerEl=null, bathTimeLeft=60, bathTimerId=null;

    let camBox=null, camPrev=null, camViz=null, vizCtx=null, energyText=null;
    let energyEMA = 0, lastPalmX=null, lastT=null;

    function resetCaptureState(){
  energyEMA = 0;
  lastPalmX = null;
  lastT = null;
  motionActive = false;
  lastBubbleAt = 0;
}

    /* =========================
       룰 팝업
    ========================= */
    function renderRules(){
      const popup=document.getElementById("rulePopup");
      popup.innerHTML=`
        <h2>!Rule!</h2>
        <ul>
          <li>좌측 패널의 순서대로 야옹이를 씻긴다.</li>
          <li>사물을 클릭해 야옹이 위에 떨구면 세정 시작!</li>
          <li>손을 카메라에 대고 좌우로 흔들면 야옹이를 씻길 수 있다. 충분히 씻기면 다음 단계로!</li>
          <li>우측 상단 타이머가 끝나기 전까지 목욕을 끝내면 성공~</li>
        </ul>
        <button onclick="startBathFlow()">&gt; 게임 시작하기 &lt;</button>`;
    }
    function showRules(){
      renderRules();
      document.getElementById("overlay").style.display="block";
      document.getElementById("rulePopup").style.display="block";
    }

    /* =========================
       시작 플로우
    ========================= */
    function startBathFlow(){
      document.getElementById("overlay").style.display="none";
      document.getElementById("rulePopup").style.display="none";

      const title=document.getElementById("title");
      if(title){ title.style.fontSize="2rem"; title.style.transform="translateY(-50px)"; }
      const subtitle=document.querySelector("h3");
      if(subtitle) subtitle.style.display="none";

      const startCat=document.getElementById("startCat");
      if(startCat) startCat.style.display="none";

      buildStage();

      resetCaptureState();

      setupMotionCapture();

      ensureTimer();
      startBathTimer(60);
    }

    function ensureTimer(){
      if (!bathTimerEl){
        bathTimerEl = document.createElement('div');
        bathTimerEl.id = 'bathTimer';
        bathTimerEl.textContent = 'TIME 60';
        document.body.appendChild(bathTimerEl);
      }
    }
    function startBathTimer(sec){
  clearBathTimer();
  bathTimeLeft = sec;
  updateBathTimer();
  bathTimerId = setInterval(()=>{
    if (!gameActive) { clearBathTimer(); return; }

    bathTimeLeft--;
    updateBathTimer();
    if (bathTimeLeft <= 0){
      clearBathTimer();
      endGameOver(false);
    }
  }, 1000);
}
    function updateBathTimer(){
      if (bathTimerEl) bathTimerEl.textContent = 'TIME ' + bathTimeLeft;
    }
    function clearBathTimer(){
      if (bathTimerId){ clearInterval(bathTimerId); bathTimerId=null; }
    }

    /* =========================
       스테이지(사물 배치)
    ========================= */
    function buildStage(){
      gameActive=true;

      let stage=document.getElementById("bathStage");
      if(!stage){
        stage=document.createElement("div");
        stage.id="bathStage";
        document.body.appendChild(stage);
      }
      stage.innerHTML="";
      Object.assign(stage.style,{position:"relative",width:"100%",height:"70vh",maxHeight:"720px",margin:"0 auto",overflow:"visible"});

      bubbleLayer=document.createElement("div");
      bubbleLayer.id="bubbleLayer";
      Object.assign(bubbleLayer.style,{position:"absolute",inset:"0",pointerEvents:"none"});
      stage.appendChild(bubbleLayer);

      addObj("tub","bathtub.png",49,35,40,true);
      addObj("catFace","eyesopened.png",49,37,14,false);
      addObj("soap","soap.png",16,50,16,true);
      addObj("yShampoo","y_shampoo.png",83,10,8,true);
      addObj("gShampoo","g_shampoo.png",76,10,8.1,true);
      addObj("towel","towel.png",80,35,14,true);

      stage.querySelectorAll("[data-clickable='1']").forEach(el=>{
        el.addEventListener("click", onPick);
      });

      buildStepsPanel();
    }

    function addObj(id, src, leftVW, topVH, widthVW, clickable){
      const stage=document.getElementById("bathStage");
      const img=document.createElement("img");
      img.id=id; img.src=src;
      if(clickable) img.setAttribute("data-clickable","1");
      Object.assign(img.style,{
        position:"absolute", left:leftVW+"vw", top:topVH+"vh", width:widthVW+"vw",
        transform:"translate(-50%,-50%)", imageRendering:"pixelated", userSelect:"none",
        cursor: clickable? "pointer":"default"
      });
      stage.appendChild(img);
    }

    function onPick(e){
      const id=e.currentTarget.id;
      const mapped=mapTool(id); 
      currentTool=mapped;

      if(!ghostImg){
        ghostImg=document.createElement("img");
        ghostImg.id="cursorGhost";
        Object.assign(ghostImg.style,{
          position:"fixed",top:0,left:0,width:"96px",transform:"translate(-50%,-50%)",
          pointerEvents:"none",imageRendering:"pixelated",filter:"drop-shadow(2px 2px 0 #333)",zIndex:1002
        });
        document.body.appendChild(ghostImg);
        document.addEventListener("mousemove", followGhost);
        document.addEventListener("mouseup", tryDropOnCat);
      }
      ghostImg.src=e.currentTarget.src;

      const w=Math.min(140, Math.max(72, e.currentTarget.getBoundingClientRect().width*0.6));
      ghostImg.style.width=w+"px";
    }
    function followGhost(ev){
      if(!ghostImg) return;
      ghostImg.style.left=ev.clientX+"px";
      ghostImg.style.top =ev.clientY+"px";
    }
    function tryDropOnCat(ev){
      if(!ghostImg || !currentTool) return;
      const cat=document.getElementById("catFace");
      const r=cat.getBoundingClientRect();
      const x=ev.clientX, y=ev.clientY;
      const hit=(x>=r.left && x<=r.right && y>=r.top && y<=r.bottom);

      if(hit){
        const expect=steps[activeStepIndex].id;
        if(currentTool===expect){
          startWashing(currentTool);
          spawnBubbles(14);
        }else{
          shakeCat();
          showWrongOrderPopup(currentTool);
        }
      }
      ghostImg.remove(); ghostImg=null; currentTool=null;
    }
    function mapTool(id){
      if(id==="tub") return "water";
      if(id==="gShampoo") return "shampoo_g";
      if(id==="yShampoo") return "shampoo_y";
      return id;
    }
    function showWrongOrderPopup(toolId){
      const toolNames = {
        "soap": "사용자의 실수로 비누가",
        "shampoo_g": "사용자의 실수로 샴푸가",
        "shampoo_y": "사용자의 실수로 바디워시가", 
        "water": "사용자의 실수로 물이",
        "towel": "사용자의 실수로 수건이"
      };
      
      const toolName = toolNames[toolId] || "도구";
      
      document.getElementById("overlay").style.display="block";
      const popup=document.getElementById("rulePopup");
      popup.style.display="block";
      popup.innerHTML=`
        <h2>아뿔싸!</h2>
        <p style="font-size:0.9rem;text-align:center;">${toolName}  낭비되었어요!<br> 환경을 지켜주세요.</p>
        <button onclick="closeWrongOrderPopup()">&gt; 계속하기 &lt;</button>`;
    }
    
    function closeWrongOrderPopup(){
      document.getElementById("overlay").style.display="none";
      document.getElementById("rulePopup").style.display="none";
    }
    
    function shakeCat(){
      const cat=document.getElementById("catFace");
      cat.style.transition="transform .08s";
      cat.style.transform="translate(-50%,-50%) rotate(3deg)";
      setTimeout(()=>{ cat.style.transform="translate(-50%,-50%) rotate(-3deg)"; },80);
      setTimeout(()=>{ cat.style.transform="translate(-50%,-50%)"; cat.style.transition=""; },160);
    }


    function buildStepsPanel(){
      const base = [
        { id:"soap",      icon:"soap.png",       label:"soap" },
        { id:"shampoo_g", icon:"g_shampoo.png",  label:"shampoo" },
        { id:"water",     icon:"bathtub.png",    label:"water" },
        { id:"shampoo_y", icon:"y_shampoo.png",  label:"body wash" },
        { id:"towel",     icon:"towel.png",      label:"towel" },
      ];
      for (let i=base.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [base[i], base[j]] = [base[j], base[i]];
      }
      steps = base.slice();
      steps.push({ id:"water", icon:"bathtub.png", label:"water" });
      activeStepIndex = 0;

      let panel=document.getElementById("stepsPanel");
      if(!panel){
        panel=document.createElement("div");
        panel.id="stepsPanel";
        document.body.appendChild(panel);
      }
      Object.assign(panel.style,{
        position:"fixed", top:"50px", left:"50px", zIndex:"900",
        fontFamily:"DosSammul, monospace", fontSize:"0.65rem", color:"#222",
        imageRendering:"pixelated"
      });

      panel.innerHTML="";
      steps.forEach((s,idx)=>{
        const row=document.createElement("div");
        Object.assign(row.style,{ display:"flex", alignItems:"center", marginBottom:"10px" });

        const box=document.createElement("div");
        Object.assign(box.style,{
          width:"64px", height:"64px", background:"#fff",
          border:"3px solid #333", boxShadow:"4px 4px 0 #666",
          display:"flex", alignItems:"center", justifyContent:"center",
          borderRadius:"6px", marginRight:"20px"
        });
        const img=document.createElement("img");
        img.src=s.icon; img.alt=s.label; img.style.width="44px"; img.style.imageRendering="pixelated";
        box.appendChild(img);

        const right=document.createElement("div");
        right.innerHTML=`<div style="font-weight:700">${s.label}</div>
                         <div class="bar" style="width:90px;height:8px;border:2px solid #333;background:#eee;box-shadow:2px 2px 0 #999;margin-top:6px">
                           <div id="bar-${idx}" style="height:100%;width:0;background:#7fd1ff"></div>
                         </div>`;
        right.style.width="110px";

        const arrow=document.createElement("div");
        arrow.textContent = (idx<steps.length-1? "▶︎":"");
        Object.assign(arrow.style,{ marginLeft:"8px", fontWeight:"700" });

        row.appendChild(box); row.appendChild(right); row.appendChild(arrow);
        row.dataset.stepIndex=idx;
        panel.appendChild(row);
      });
      highlightStep(0);

      ensureCamBoxBesidePanel();
    }

    function highlightStep(i){
      const panel=document.getElementById("stepsPanel");
      [...panel.children].forEach((row,idx)=>{
        row.style.opacity=(idx<i)?"0.4":"1";
        row.children[0].style.borderColor=(idx===i)?"#ffcc00":"#333";
        row.children[0].style.boxShadow =(idx===i)?"4px 4px 0 #b07":"4px 4px 0 #666";
      });
    }
    function markStepDone(i){
      const panel=document.getElementById("stepsPanel");
      const row=panel.children[i]; if(!row) return;
      row.style.opacity="0.5";
      if(i+1<steps.length) highlightStep(i+1);
      if(i+1===steps.length){
        setTimeout(()=>endGameClear(),300);
      }
    }

    function startWashing(toolId){
      const cfg=WASH_CFG[toolId]||{goal:150,gain:0.5};
      washing={active:true, tool:toolId, progress:0, goal:cfg.goal, gain:cfg.gain};
    }
    function tickWashing(energy){
      if(!washing.active) return;
      const TH = MOTION_TH;

      if (energy > TH){
        const add = (energy - TH) * washing.gain;
        washing.progress += add;

        const intensity = Math.min(16, 4 + (energy - TH)*0.22);
        spawnBubblesThrottled(intensity);

        setCatMood(true);
      } else {
        setCatMood(false);
      }

      const bar = document.getElementById(`bar-${activeStepIndex}`);
      if (bar){
        const pct = Math.min(100, Math.round((washing.progress/washing.goal)*100));
        bar.style.width = pct + "%";
      }

      if (washing.progress >= washing.goal){
        washing.active = false;
        markStepDone(activeStepIndex);
        activeStepIndex++;
      }
    }

    let eyesClosed=false;
    function setCatMood(closed){
      const cat=document.getElementById('catFace');
      if(!cat) return;
      if (closed && !eyesClosed){ cat.src='eyesclosed.png';; eyesClosed=true; }
      if (!closed && eyesClosed){ cat.src='eyesopened.png';; eyesClosed=false; }
    }

    function spawnBubblesThrottled(intensity){
      const now = performance.now();
      if (now - lastBubbleAt < BUBBLE_COOLDOWN) return;
      lastBubbleAt = now;
      spawnBubbles(intensity);
    }
    function spawnBubbles(intensity=10){
      if(!bubbleLayer) return;
      const cat=document.getElementById("catFace");
      if(!cat) return;
      const rect=cat.getBoundingClientRect();
      const imgs=["bubble1.png","bubble2.png","bubble3.png"];
      const n=Math.min(12,Math.max(2,Math.round(intensity*0.3)));

      for(let i=0;i<n;i++){
        const b=document.createElement("img");
        b.src=imgs[Math.floor(Math.random()*imgs.length)];
        Object.assign(b.style,{
          position:"fixed",
          left:(rect.left + rect.width*0.18 + Math.random()*rect.width*0.64)+"px",
          top :(rect.top  + rect.height*0.12 + Math.random()*rect.height*0.55)+"px",
          width:(9+Math.random()*8)+"px",
          opacity:"0.95", imageRendering:"pixelated", pointerEvents:"none",
          transition:"transform 500ms ease-out, opacity 500ms ease-out",
          filter:"drop-shadow(1px 1px 0 #88cfff)", zIndex:1001
        });
        bubbleLayer.appendChild(b);
        requestAnimationFrame(()=>{
          b.style.transform=`translate(${(Math.random()*2-1)*12}px, -18px) scale(${1.1+Math.random()*0.25})`;
          b.style.opacity="0";
        });
        setTimeout(()=>b.remove(),520);
      }
    }

    function endGameClear(){
      stopMotionCapture();
      clearBathTimer();
      gameActive=false;
      document.getElementById("overlay").style.display="block";
      const popup=document.getElementById("rulePopup");
      popup.style.display="block";
      popup.innerHTML=`
        <h2>GAME CLEAR!</h2>
        <p style="font-size:0.9rem;text-align:center;">야옹이가 깨끗해졌어요~<br> 앞으로도 지구를 위해 샴푸를 조금씩 사용하고, 물을 아껴주세요.</p>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:40px;">
      <button style="margin:0;" onclick="backToMenu()">&gt; 메뉴로 이동 &lt;</button>
      <button style="margin:0;" onclick="startBathFlow()">&gt; 다시 하기 &lt;</button>
    </div>`;
    }
    function endGameOver(success = false) {
  stopMotionCapture();
  clearBathTimer();
  gameActive = false;

  document.getElementById("overlay").style.display = "block";
  const popup = document.getElementById("rulePopup");
  popup.style.display = "block";

  const resultHtml = success
    ? `<h2>GAME CLEAR!</h2><p style="font-size:0.9rem;text-align:center;">야옹이가 깨끗해졌어요~<br> 앞으로도 지구를 위해 샴푸를 조금씩 사용하고, 물을 아껴주세요.</p>`
    : `<h2>GAME OVER :(</h2><p style="font-size:0.9rem;text-align:center;">야옹이를 조금 더 빨리 씻겨주세요~<br> 그래도 샴푸, 물 낭비는 금물!</p>`;

  popup.innerHTML = `
    ${resultHtml}
    <div style="display:flex; justify-content:center; gap:20px; margin-top:40px;">
      <button style="margin:0;" onclick="backToMenu()">&gt; 메뉴로 이동 &lt;</button>
      <button style="margin:0;" onclick="startBathFlow()">&gt; 다시 하기 &lt;</button>
    </div>
  `;
}
    
    function backToMenu(){
      stopMotionCapture();
      clearBathTimer();
      if(ghostImg){ ghostImg.remove(); ghostImg=null; }
      currentTool=null; washing={active:false, tool:null, progress:0, goal:0, gain:0.5};

      const stage=document.getElementById("bathStage"); if(stage) stage.remove();
      const panel=document.getElementById("stepsPanel"); if(panel) panel.remove();
      const cam=document.getElementById("camBox"); if(cam) cam.remove();
      const timer=document.getElementById("bathTimer"); if(timer) timer.remove(); bathTimerEl=null;

      document.getElementById("overlay").style.display="none";
      renderRules();
      document.getElementById("rulePopup").style.display="none";

      const title=document.getElementById("title");
      if(title){ title.style.fontSize="4rem"; title.style.transform="translateY(0)"; }
      const subtitle=document.querySelector("h3");
      if(subtitle) subtitle.style.display="block";

      const startCat=document.getElementById("startCat");
      if(startCat) startCat.style.display="inline";
    }

    function ensureCamBoxBesidePanel(){
      if (document.getElementById('camBox')) return;
      camBox=document.createElement('div'); camBox.id='camBox';
      const wrap=document.createElement('div'); wrap.style.position='relative';
      camPrev=document.createElement('video');
      Object.assign(camPrev,{autoplay:true, playsInline:true, muted:true});
      Object.assign(camPrev.style,{width:'0px',height:'0px',display:'none'}); // 숨김
      camViz=document.createElement('canvas'); camViz.width=200; camViz.height=150;
      vizCtx=camViz.getContext('2d',{willReadFrequently:true});
      const cap=document.createElement('div'); cap.className='cap'; cap.textContent='hand energy';
      camBox.appendChild(camViz); camBox.appendChild(cap);
      document.body.appendChild(camBox);
    }

    function loadScript(src){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=src; s.onload=()=>res(); s.onerror=rej; document.head.appendChild(s);
      });
    }

    let mpHands=null, mpCamera=null;
    async function setupMotionCapture(){
      if (mpCamera && mpCamera.stop) { 
    try { mpCamera.stop(); } catch(e){}
  }
  mpCamera = null;

      ensureCamBoxBesidePanel();
      try{
        await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js');
        await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js');

        mpHands=new Hands({ locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
        mpHands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
        mpHands.onResults(onHandsResults);

        mpCamera=new Camera(camPrev,{
          onFrame: async ()=>{ await mpHands.send({image:camPrev}); },
          width:320, height:240
        });
        mpCamera.start();
      }catch(e){
        console.warn('웹캠 권한을 허용해주세요!',e);
        setupMotionCaptureFallback();
      }
    }

    function onHandsResults(results){
      vizCtx.clearRect(0,0,camViz.width,camViz.height);

      let energyOut = 0;
      const now = performance.now();

      if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
        const lm = results.multiHandLandmarks[0];

        const palms=[0,5,9,13,17];
        let cx=0, cy=0; palms.forEach(i=>{ cx+=lm[i].x; cy+=lm[i].y; });
        cx/=palms.length; cy/=palms.length;

        const px = (1-cx)*camViz.width;
        const py = cy*camViz.height;

        for(let i=0;i<lm.length;i++){
          const x=(1-lm[i].x)*camViz.width, y=lm[i].y*camViz.height;
          vizCtx.beginPath(); vizCtx.arc(x,y,2.5,0,Math.PI*2);
          vizCtx.fillStyle='#00e0a8'; vizCtx.fill();
        }

        vizCtx.beginPath(); vizCtx.arc(px,py,12,0,Math.PI*2);
        vizCtx.fillStyle='rgba(127,209,255,0.6)'; vizCtx.fill();
        vizCtx.strokeStyle='#003'; vizCtx.lineWidth=2; vizCtx.stroke();

        if(lastPalmX!=null && lastT!=null){
          const dt = Math.max(16, now - lastT);
          const vx = Math.abs(px - lastPalmX) / dt;
          const raw = vx * 2600;
          const riseAlpha = 0.25, decayRate = 0.86;
          energyEMA = Math.max(raw, energyEMA*decayRate);
          energyEMA = energyEMA*(1-riseAlpha) + raw*riseAlpha;
          energyOut = Math.min(255, energyEMA);
        }
        lastPalmX = px; lastT = now;

        tickWashing(energyOut);
      } else {
        energyEMA *= 0.4;
        lastPalmX = null; lastT = null;
        lastBubbleAt = performance.now();
        setCatMood(false);
      }
    }

    let motionRAF=null, videoEl=null, cvsA=null, ctxA=null, cvsB=null, ctxB=null, lastFrameIsA=true;
    async function setupMotionCaptureFallback(){
      ensureCamBoxBesidePanel();
      if(!videoEl){
        videoEl=document.createElement('video');
        Object.assign(videoEl,{autoplay:true, playsInline:true, muted:true});
        videoEl.style.display="none"; document.body.appendChild(videoEl);
      }
      if(!cvsA){cvsA=document.createElement('canvas');cvsA.width=96;cvsA.height=72;ctxA=cvsA.getContext('2d',{willReadFrequently:true});}
      if(!cvsB){cvsB=document.createElement('canvas');cvsB.width=96;cvsB.height=72;ctxB=cvsB.getContext('2d',{willReadFrequently:true});}

      let stream;
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:{width:320,height:240},audio:false});
      }catch(err){
        alert('카메라 권한을 허용해 주세요!'); return;
      }
      videoEl.srcObject=stream; camPrev.srcObject=stream;

      if(motionRAF) cancelAnimationFrame(motionRAF);
      lastFrameIsA=true;

      const loop=()=>{
        const ctxSrc= lastFrameIsA? ctxA:ctxB;
        const ctxDst= lastFrameIsA? ctxB:ctxA;
        ctxSrc.drawImage(videoEl,0,0,cvsA.width,cvsA.height);

        const src=ctxSrc.getImageData(0,0,cvsA.width,cvsA.height).data;
        const dst=ctxDst.getImageData(0,0,cvsA.width,cvsA.height); const d=dst.data;

        let sum=0,count=0,sumX=0,sumY=0; const thPix=60;
        for(let y=0;y<cvsA.height;y++){
          for(let x=0;x<cvsA.width;x++){
            const i=(y*cvsA.width+x)*4;
            const diff=Math.abs(d[i]-src[i])+Math.abs(d[i+1]-src[i+1])+Math.abs(d[i+2]-src[i+2]);
            sum+=diff; d[i]=src[i]; d[i+1]=src[i+1]; d[i+2]=src[i+2]; d[i+3]=255;
            if(diff>thPix){count++; sumX+=x; sumY+=y;}
          }
        }
        ctxDst.putImageData(dst,0,0);
        lastFrameIsA=!lastFrameIsA;

        const energy=sum/(cvsA.width*cvsA.height*3);
        tickWashing(energy);

        vizCtx.clearRect(0,0,camViz.width,camViz.height);
        if(count>25){
          const cx=(sumX/count)*(camViz.width/cvsA.width);
          const cy=(sumY/count)*(camViz.height/cvsA.height);
          vizCtx.beginPath(); vizCtx.arc(cx,cy,10,0,Math.PI*2);
          vizCtx.fillStyle='rgba(127,209,255,0.7)'; vizCtx.fill();
          vizCtx.lineWidth=2; vizCtx.strokeStyle='#003'; vizCtx.stroke();
        }
        motionRAF=requestAnimationFrame(loop);
      };
      loop();
    }

    function stopMotionCapture(){
      if(mpCamera && mpCamera.stop) mpCamera.stop();
      mpCamera=null;
      if(motionRAF) cancelAnimationFrame(motionRAF);
      motionRAF=null;
      if(videoEl && videoEl.srcObject){ videoEl.srcObject.getTracks().forEach(t=>t.stop()); videoEl.srcObject=null; }
      if(camPrev && camPrev.srcObject){ camPrev.srcObject.getTracks().forEach(t=>t.stop()); camPrev.srcObject=null; }
    }

    window.addEventListener("DOMContentLoaded",()=>{
      renderRules();
      const sc=document.getElementById("startCat");
      if(sc){ sc.addEventListener("click", showRules); }
    });
  </script>
</body>
</html>