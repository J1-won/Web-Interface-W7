<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì•¼ì˜¹ì•„ëª©ìš•í•˜ì</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'DosSammul';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_eight@1.0/DOSSaemmul.woff') format('woff');
      font-weight: normal;
      font-display: swap;
    }
    html{font-size:2rem;scroll-behavior:smooth;}
    body,h1,h2,h3,p,ol,ul{margin:0;padding:0;}
    h1{
      font-family:"Jersey 10",sans-serif;font-weight:400;font-size:4rem;text-align:center;
      padding:200px 0 20px 0;
      text-shadow:7px 7px 0 white,-7px -7px 0 white,7px -7px 0 white,-7px 7px 0 white;
      filter:drop-shadow(5px 5px 0 #73564b);
      z-index:999;position:relative;
    }
    h3{
      font-family:'DosSammul',sans-serif;font-weight:400;font-size:1rem;text-align:center;
      padding-bottom:70px;
      text-shadow:2px 2px 0 white,-2px -2px 0 white,2px -2px 0 white,-2px 2px 0 white;
      filter:drop-shadow(2px 2px 0 #73564b);z-index:999;position:relative;
    }
    .bg{background:url(bathroom_n.jpg) no-repeat center center fixed;background-size:cover;overflow-x:hidden;}
    #overlay{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:999;
    }
    #rulePopup{
      display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      width:700px;background:white;border:5px solid black;box-shadow:6px 6px 0 #333;
      padding:50px 30px;font-family:'DosSammul';line-height:1.3rem;font-size:0.7rem;color:black;z-index:1000;
    }
    #rulePopup h2{text-align:center;margin-bottom:60px;font-size:1.8rem;}
    #rulePopup ul{text-align:left;padding-left:20px;}
    #rulePopup button{
      display:block;margin:40px auto 0 auto;padding:15px 15px;border:3px solid black;background:white;
      font-family:'DosSammul';font-size:0.5rem;cursor:pointer;filter:drop-shadow(3px 3px 0 #555);
    }
    #rulePopup button:hover{background:black;color:white;}
    /* ìŠ¤í…Œì´ì§€ */
    #bathStage{position:relative;width:100%;height:70vh;max-height:720px;margin:0 auto;z-index:10;}
    .clickable{position:absolute;cursor:pointer;image-rendering:pixelated;user-select:none;}
    /* ë‹¨ê³„ íŒ¨ë„ */
    #stepsPanel{position:fixed;top:50px;left:50px;z-index:900;font-family:'DosSammul',monospace;font-size:0.65rem;color:#222;image-rendering:pixelated;}
  </style>
</head>
<body class="bg">
  <h1 id="title">Bathe the Cat!</h1>
  <h3>ì•¼ì˜¹ì´ì˜ ì™¸ì¶œ ì¤€ë¹„ë¥¼ ë„ì™€ì£¼ì„¸ìš”!</h3>

  <div style="text-align:center;">
    <!-- ì²˜ìŒ ê³ ì–‘ì´ ì´ë¯¸ì§€ë¥¼ ëˆ„ë¥´ë©´ ë£° íŒì—… -->
    <img src="dirtcat.png" id="startCat" style="width:420px;cursor:pointer;padding-top:30px">
  </div>

  <div id="overlay"></div>
  <div id="rulePopup"></div>

  <!-- (ì´ì „ ê³¼ì œ í”ì : ìˆ¨ê²¨ë†”ë„ ë¬´ë°©) -->
  <div id="gameUI" style="display:none;">
    <div id="timer">TIME 30</div>
    <div id="hearts">
      <img src="heart.png"><img src="heart.png"><img src="heart.png">
    </div>
    <img src="cat.jpg" id="cat" style="display:none;">
  </div>

  <script>
    let gameActive=false;

    // ë„êµ¬/ë‹¨ê³„ ì§„í–‰
    let currentTool=null, ghostImg=null;let energyEMA = 0;  // ì† ì†ë„ ì§€ìˆ˜í‰í™œ(í‘œì‹œ/ê²Œì„ìš©)
    let steps=[], activeStepIndex=0;
    // ì†ë™ì‘ ì„ê³„ + ë²„ë¸” ìŠ¤ë¡œí‹€
const MOTION_TH = 2;          // ì† ì¸ì‹ ì„ê³„ì¹˜
let motionActive = false;       // ì§ì „ í”„ë ˆì„ ì†ë™ì‘ ì—¬ë¶€
let lastBubbleAt = 0;           // ìµœê·¼ ê±°í’ˆ ìƒì„± ì‹œê°
const BUBBLE_COOLDOWN = 70;     // ê±°í’ˆ ìµœì†Œ ê°„ê²©(ms)

function spawnBubblesThrottled(intensity){
  const now = performance.now();
  if (now - lastBubbleAt < BUBBLE_COOLDOWN) return;
  lastBubbleAt = now;
  spawnBubbles(intensity);
}

    const WASH_CFG={
      soap:{goal:15000,gain:0.6},
      shampoo_g:{goal:11000,gain:0.65},
      shampoo_y:{goal:12000,gain:0.6},
      water:{goal:14000,gain:0.55},
      towel:{goal:10000,gain:0.5}
    };
    let washing={active:false, tool:null, progress:0, goal:0, gain:0.5};

    // ë²„ë¸” ë ˆì´ì–´ ì°¸ì¡°
    let bubbleLayer=null;

    /* =========================
       ë£° íŒì—…
    ========================= */
    function renderRules(){
      const popup=document.getElementById("rulePopup");
      popup.innerHTML=`
        <h2>!Rule!</h2>
        <ul>
          <li>ì¢Œì¸¡ íŒ¨ë„ì˜ <b>ìˆœì„œ</b>ëŒ€ë¡œ ì•¼ì˜¹ì´ë¥¼ ì”»ê²¨ìš”.</li>
          <li>ì‚¬ë¬¼ì„ <b>í´ë¦­</b>í•´ ì»¤ì„œì— ë¶™ì´ê³ , <b>ê³ ì–‘ì´ ìœ„ì— ë–¨êµ¬ë©´</b> ì„¸ì • ì‹œì‘!</li>
          <li>ì˜¤ë¥¸ì†ì„ ì¢Œìš°ë¡œ í”ë“¤ë©´(ì›¹ìº ) ê±°í’ˆì´ ëŠ˜ì–´ë‚˜ìš”. ì¶©ë¶„íˆ ì”»ê¸°ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ!</li>
        </ul>
        <button onclick="startBathFlow()">&gt; ê²Œì„ ì‹œì‘í•˜ê¸° &lt;</button>`;
    }
    function showRules(){
      renderRules();
      document.getElementById("overlay").style.display="block";
      document.getElementById("rulePopup").style.display="block";
    }

    /* =========================
       ì‹œì‘ íë¦„
    ========================= */
    function startBathFlow(){
      // íŒì—… ë‹«ê¸°
      document.getElementById("overlay").style.display="none";
      document.getElementById("rulePopup").style.display="none";

      // ìƒë‹¨ íƒ€ì´í‹€/ì„¤ëª… ì •ë¦¬
      const title=document.getElementById("title");
      if(title){ title.style.fontSize="2rem"; title.style.transform="translateY(-50px)"; }
      const subtitle=document.querySelector("h3");
      if(subtitle) subtitle.style.display="none";

      // ì¸íŠ¸ë¡œ ê³ ì–‘ì´ ìˆ¨ê¸°ê¸°
      const startCat=document.getElementById("startCat");
      if(startCat) startCat.style.display="none";

      // ë°°ê²½ ì „í™˜
      const bodyBg=document.querySelector("body.bg");
      if(bodyBg) bodyBg.classList.add("wet");

      // ìŠ¤í…Œì´ì§€ UI êµ¬ì„±
      buildStage();

      // ì† ì¶”ì  ì‹œì‘(ìš°ìƒë‹¨ ë¯¸ë¦¬ë³´ê¸° í¬í•¨)
      setupMotionCapture();
    }

    /* =========================
       ìŠ¤í…Œì´ì§€ êµ¬ì„±(ì‚¬ë¬¼ ë°°ì¹˜)
    ========================= */
    function buildStage(){
      gameActive=true;

      let stage=document.getElementById("bathStage");
      if(!stage){
        stage=document.createElement("div");
        stage.id="bathStage";
        document.body.appendChild(stage);
      }
      stage.innerHTML="";
      Object.assign(stage.style,{position:"relative",width:"100%",height:"70vh",maxHeight:"720px",margin:"0 auto",overflow:"visible"});

      // ë²„ë¸” ë ˆì´ì–´
      bubbleLayer=document.createElement("div");
      bubbleLayer.id="bubbleLayer";
      Object.assign(bubbleLayer.style,{position:"absolute",inset:"0",pointerEvents:"none"});
      stage.appendChild(bubbleLayer);

      // ì˜¤ë¸Œì íŠ¸ (ê³ ì–‘ì´ëŠ” í´ë¦­ ë¶ˆê°€)
      addObj("tub","bathtub.png",49,35,40,true);          // ë¬¼ ì—­í• : tub â†’ water
      addObj("catFace","eyesopened.png",49,37,14,false);   // í´ë¦­ ë¶ˆê°€
      addObj("soap","soap.png",16,50,16,true);
      addObj("yShampoo","y_shampoo.png",83,10,8,true);
      addObj("gShampoo","g_shampoo.png",76,10,8.1,true);
      addObj("towel","towel.png",80,35,14,true);

      stage.querySelectorAll("[data-clickable='1']").forEach(el=>{
        el.addEventListener("click", onPick);
      });

      buildStepsPanel();
    }

    function addObj(id, src, leftVW, topVH, widthVW, clickable){
      const stage=document.getElementById("bathStage");
      const img=document.createElement("img");
      img.id=id; img.src=src;
      if(clickable) img.setAttribute("data-clickable","1");
      Object.assign(img.style,{
        position:"absolute", left:leftVW+"vw", top:topVH+"vh", width:widthVW+"vw",
        transform:"translate(-50%,-50%)", imageRendering:"pixelated", userSelect:"none",
        cursor: clickable? "pointer":"default"
      });
      stage.appendChild(img);
    }

    /* =========================
       ë„êµ¬ ì„ íƒ â†’ ì»¤ì„œ ê³ ìŠ¤íŠ¸ ìƒì„±
    ========================= */
    function onPick(e){
      const id=e.currentTarget.id;          // soap / yShampoo / gShampoo / towel / tub
      const mapped=mapTool(id);             // soap / shampoo_g / shampoo_y / towel / water
      currentTool=mapped;

      // ê³ ìŠ¤íŠ¸ ìƒì„±
      if(!ghostImg){
        ghostImg=document.createElement("img");
        ghostImg.id="cursorGhost";
        Object.assign(ghostImg.style,{
          position:"fixed",top:0,left:0,width:"96px",transform:"translate(-50%,-50%)",
          pointerEvents:"none",imageRendering:"pixelated",filter:"drop-shadow(2px 2px 0 #333)",zIndex:1002
        });
        document.body.appendChild(ghostImg);
        document.addEventListener("mousemove", followGhost);
        document.addEventListener("mouseup", tryDropOnCat);
      }
      ghostImg.src=e.currentTarget.src;

      // í¬ê¸° ë³´ì •
      const w=Math.min(140, Math.max(72, e.currentTarget.getBoundingClientRect().width*0.6));
      ghostImg.style.width=w+"px";
    }
    function followGhost(ev){
      if(!ghostImg) return;
      ghostImg.style.left=ev.clientX+"px";
      ghostImg.style.top =ev.clientY+"px";
    }
    function tryDropOnCat(ev){
      if(!ghostImg || !currentTool) return;
      const cat=document.getElementById("catFace");
      const r=cat.getBoundingClientRect();
      const x=ev.clientX, y=ev.clientY;
      const hit=(x>=r.left && x<=r.right && y>=r.top && y<=r.bottom);

      if(hit){
        const expect=steps[activeStepIndex].id;
        if(currentTool===expect){
          // ì˜¬ë°”ë¥¸ ë„êµ¬ â†’ ì„¸ì • ì‹œì‘ + ì¦‰ì‹œ ì‘ì€ ê±°í’ˆ
          startWashing(currentTool);
          spawnBubbles(14);
        }else{
          // í‹€ë¦¬ë©´ ê³ ì–‘ì´ í”ë“¤
          shakeCat();
        }
      }
      ghostImg.remove(); ghostImg=null; currentTool=null;
    }
    function mapTool(id){
      if(id==="tub") return "water";
      if(id==="gShampoo") return "shampoo_g";
      if(id==="yShampoo") return "shampoo_y";
      return id; // soap / towel
    }
    function shakeCat(){
      const cat=document.getElementById("catFace");
      cat.style.transition="transform .08s";
      cat.style.transform="translate(-50%,-50%) rotate(3deg)";
      setTimeout(()=>{ cat.style.transform="translate(-50%,-50%) rotate(-3deg)"; },80);
      setTimeout(()=>{ cat.style.transform="translate(-50%,-50%)"; cat.style.transition=""; },160);
    }

    function buildStepsPanel(){
  // í…œí”Œë¦¿ì„ ë§Œë“¤ê³  â†’ Fisher-Yatesë¡œ ì„ì–´ì„œ stepsì— ì €ì¥
  const template = [
    { id:"soap",      icon:"soap.png",       label:"soap" },
    { id:"shampoo_g", icon:"g_shampoo.png",  label:"shampoo" },
    { id:"water",     icon:"bathtub.png",    label:"water" },
    { id:"shampoo_y", icon:"y_shampoo.png",  label:"rinse" },
    { id:"towel",     icon:"towel.png",      label:"towel" },
  ];
  // Fisherâ€“Yates shuffle
  for (let i=template.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [template[i], template[j]] = [template[j], template[i]];
  }
  steps = template;
  activeStepIndex = 0;

  let panel=document.getElementById("stepsPanel");
  if(!panel){
    panel=document.createElement("div");
    panel.id="stepsPanel";
    document.body.appendChild(panel);
  }
  Object.assign(panel.style,{
    position:"fixed", top:"50px", left:"50px", zIndex:"900",
    fontFamily:"DosSammul, monospace", fontSize:"0.65rem", color:"#222",
    imageRendering:"pixelated"
  });

  panel.innerHTML="";
  steps.forEach((s,idx)=>{
    const row=document.createElement("div");
    Object.assign(row.style,{ display:"flex", alignItems:"center", marginBottom:"10px" });

    const box=document.createElement("div");
    Object.assign(box.style,{
      width:"64px", height:"64px", background:"#fff",
      border:"3px solid #333", boxShadow:"4px 4px 0 #666",
      display:"flex", alignItems:"center", justifyContent:"center",
      borderRadius:"6px", marginRight:"8px"
    });
    const img=document.createElement("img");
    img.src=s.icon; img.alt=s.label; img.style.width="44px"; img.style.imageRendering="pixelated";
    box.appendChild(img);

    const right=document.createElement("div");
    right.innerHTML=`<div style="font-weight:700">${s.label}</div>
                     <div class="bar" style="width:90px;height:8px;border:2px solid #333;background:#eee;box-shadow:2px 2px 0 #999;margin-top:6px">
                       <div id="bar-${idx}" style="height:100%;width:0;background:#7fd1ff"></div>
                     </div>`;
    right.style.width="110px";

    const arrow=document.createElement("div");
    arrow.textContent = (idx<steps.length-1? "â–¶ï¸":"");
    Object.assign(arrow.style,{ marginLeft:"8px", fontWeight:"700" });

    row.appendChild(box); row.appendChild(right); row.appendChild(arrow);
    row.dataset.stepIndex=idx;
    panel.appendChild(row);
  });
  highlightStep(0);
}
    function highlightStep(i){
      const panel=document.getElementById("stepsPanel");
      [...panel.children].forEach((row,idx)=>{
        row.style.opacity=(idx<i)?"0.4":"1";
        row.children[0].style.borderColor=(idx===i)?"#ffcc00":"#333";
        row.children[0].style.boxShadow =(idx===i)?"4px 4px 0 #b07":"4px 4px 0 #666";
      });
    }
    function markStepDone(i){
      const panel=document.getElementById("stepsPanel");
      const row=panel.children[i]; if(!row) return;
      row.style.opacity="0.5";
      if(i+1<steps.length) highlightStep(i+1);
      if(i+1===steps.length){
        setTimeout(()=>endGameClear(),600);
      }
    }

    /* =========================
       ì„¸ì • ì„¸ì…˜ & ì§„í–‰ë„
    ========================= */
    function startWashing(toolId){
      const cfg=WASH_CFG[toolId]||{goal:150,gain:0.5};
      washing={active:true, tool:toolId, progress:0, goal:cfg.goal, gain:cfg.gain};
    }
    function tickWashing(energy){
  if(!washing.active) return;
  const TH = MOTION_TH; // ë™ì¼ ì„ê³„ì¹˜ ì‚¬ìš©

  if (energy > TH){
    const add = (energy - TH) * washing.gain;
    washing.progress += add;

    // íŒ¨ë„ ì§„í–‰ë„
    const bar = document.getElementById(`bar-${activeStepIndex}`);
    if (bar){
      const pct = Math.min(100, Math.round((washing.progress/washing.goal)*100));
      bar.style.width = pct + "%";
    }

    if (washing.progress >= washing.goal){
      washing.active = false;
      markStepDone(activeStepIndex);
      activeStepIndex++;
    }
  }
}

    /* =========================
       ë²„ë¸” ìƒì„±(ì‘ê³  ë§ì´)
    ========================= */
    function spawnBubbles(intensity=10){
      if(!bubbleLayer) return;
      const cat=document.getElementById("catFace");
      if(!cat) return;
      const rect=cat.getBoundingClientRect();
      const imgs=["bubble1.png","bubble2.png","bubble3.png"];
      const n=Math.min(12,Math.max(2,Math.round(intensity*0.3)));

      for(let i=0;i<n;i++){
        const b=document.createElement("img");
        b.src=imgs[Math.floor(Math.random()*imgs.length)];
        Object.assign(b.style,{
          position:"fixed",
          left:(rect.left + rect.width*0.18 + Math.random()*rect.width*0.64)+"px",
          top :(rect.top  + rect.height*0.12 + Math.random()*rect.height*0.55)+"px",
          width:(9+Math.random()*8)+"px",   /* 9~17px */
          opacity:"0.95", imageRendering:"pixelated", pointerEvents:"none",
          transition:"transform 500ms ease-out, opacity 500ms ease-out",
          filter:"drop-shadow(1px 1px 0 #88cfff)", zIndex:1001
        });
        bubbleLayer.appendChild(b);
        requestAnimationFrame(()=>{
          b.style.transform=`translate(${(Math.random()*2-1)*12}px, -18px) scale(${1.1+Math.random()*0.25})`;
          b.style.opacity="0";
        });
        setTimeout(()=>b.remove(),520);
      }
    }

    /* =========================
       í´ë¦¬ì–´
    ========================= */
    function endGameClear(){
      stopMotionCapture();
      gameActive=false;
      document.getElementById("overlay").style.display="block";
      const popup=document.getElementById("rulePopup");
      popup.style.display="block";
      popup.innerHTML=`
        <h2>GAME CLEAR!</h2>
        <p style="font-size:1.2rem;text-align:center;">ì•¼ì˜¹ì´ ì”»ê¸°ê¸° ì™„ë£Œ!</p>
        <div style="display:flex;justify-content:center;gap:16px;margin-top:20px">
          <button onclick="backToMenu()">&gt; ë©”ë‰´ë¡œ ì´ë™ &lt;</button>
          <button onclick="startBathFlow()">&gt; ë‹¤ì‹œ í•˜ê¸° &lt;</button>
        </div>`;
    }

    function backToMenu(){
      stopMotionCapture();
      if(ghostImg){ ghostImg.remove(); ghostImg=null; }
      currentTool=null; washing={active:false, tool:null, progress:0, goal:0, gain:0.5};

      // ìŠ¤í…Œì´ì§€/íŒ¨ë„ ì œê±°
      const stage=document.getElementById("bathStage"); if(stage) stage.remove();
      const panel=document.getElementById("stepsPanel"); if(panel) panel.remove();

      // ë°°ê²½ ì›ë³µ
      const bodyBg=document.querySelector("body.bg"); if(bodyBg) bodyBg.classList.remove("wet");

      // íŒì—… ë‹«ê¸° & ë£° ë³µì›
      document.getElementById("overlay").style.display="none";
      renderRules();
      document.getElementById("rulePopup").style.display="none";

      // íƒ€ì´í‹€/ì„¤ëª… ì›ë³µ
      const title=document.getElementById("title");
      if(title){ title.style.fontSize="4rem"; title.style.transform="translateY(0)"; }
      const subtitle=document.querySelector("h3");
      if(subtitle) subtitle.style.display="block";

      // ì¸íŠ¸ë¡œ ê³ ì–‘ì´ ë‹¤ì‹œ í‘œì‹œ
      const startCat=document.getElementById("startCat");
      if(startCat) startCat.style.display="inline";
    }

    /* =========================
       ìš°ìƒë‹¨ ë””ë²„ê·¸ í”„ë¦¬ë·° + MediaPipe Hands
    ========================= */
    let camBox=null, camPrev=null, camViz=null, vizCtx=null, energyText=null;
    function enableDebugPreview(){
  if (camBox) return;
  camBox=document.createElement('div');
  Object.assign(camBox.style,{
    position:'fixed', top:'40px', right:'40px', zIndex:1001,
    width:'220px', padding:'8px', background:'rgba(255,255,255,.88)',
    border:'3px solid #333', boxShadow:'4px 4px 0 #666',
    fontFamily:'DosSammul, monospace', fontSize:'12px', imageRendering:'pixelated'
  });

  const wrap=document.createElement('div');
  Object.assign(wrap.style,{position:'relative', width:'200px', height:'150px', margin:'0 auto 6px auto'});

  // ì…ë ¥ìš© ë¹„ë””ì˜¤ëŠ” 'ë³´ì´ì§€ ì•Šê²Œ' ìˆ¨ê¹€ (MediaPipe ì…ë ¥ì—ëŠ” ì‚¬ìš©ë¨)
  camPrev=document.createElement('video');
  Object.assign(camPrev,{autoplay:true, playsInline:true, muted:true});
  Object.assign(camPrev.style,{width:'0px',height:'0px',display:'none'}); // â† ìˆ¨ê¹€

  // ì† í‘œì‹œë§Œ ê·¸ë¦´ ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ (ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” ê±´ ì´ê±° í•˜ë‚˜)
  camViz=document.createElement('canvas');
  camViz.width=200; camViz.height=150;
  vizCtx=camViz.getContext('2d',{willReadFrequently:true});
  Object.assign(camViz.style,{display:'block',width:'200px',height:'150px'});

  wrap.appendChild(camViz); // â† ë¹„ë””ì˜¤ëŠ” ì•ˆ ë¶™ì„
  energyText=document.createElement('div'); energyText.textContent='energy: 0';
  camBox.appendChild(wrap); camBox.appendChild(energyText);
  document.body.appendChild(camBox);
}

    function loadScript(src){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=src; s.onload=()=>res(); s.onerror=rej; document.head.appendChild(s);
      });
    }

    let mpHands=null, mpCamera=null, lastPalmX=null, lastT=null;
    async function setupMotionCapture(){
      enableDebugPreview();
      try{
        await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js');
        await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js');

        // eslint-disable-next-line no-undef
        mpHands=new Hands({ locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
        mpHands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
        mpHands.onResults(onHandsResults);

        // eslint-disable-next-line no-undef
        mpCamera=new Camera(camPrev,{
          onFrame: async ()=>{ await mpHands.send({image:camPrev}); },
          width:320, height:240
        });
        mpCamera.start();
      }catch(e){
        console.warn('MediaPipe ë¡œë“œ ì‹¤íŒ¨ â†’ ì°¨ì˜ìƒ fallback ì‚¬ìš©',e);
        setupMotionCaptureFallback();
      }
    }

    function onHandsResults(results){
  // ìº”ë²„ìŠ¤(í‘œì‹œìë§Œ)
  vizCtx.clearRect(0,0,camViz.width,camViz.height);

  let energyOut = 0;
  const now = performance.now();

  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
    const lm = results.multiHandLandmarks[0];

    // ì†ë°”ë‹¥ ì¤‘ì‹¬(ëŒ€ëµ)
    const palms=[0,5,9,13,17];
    let cx=0, cy=0; palms.forEach(i=>{ cx+=lm[i].x; cy+=lm[i].y; });
    cx/=palms.length; cy/=palms.length;

    const px = (1-cx)*camViz.width;  // ì¢Œìš° ë°˜ì „
    const py = cy*camViz.height;

    // ì†ê°€ë½(ì´ˆë¡ ì )
    vizCtx.lineWidth=2; vizCtx.strokeStyle='rgba(0,0,0,.7)';
    for(let i=0;i<lm.length;i++){
      const x=(1-lm[i].x)*camViz.width, y=lm[i].y*camViz.height;
      vizCtx.beginPath(); vizCtx.arc(x,y,2.5,0,Math.PI*2);
      vizCtx.fillStyle='#00e0a8'; vizCtx.fill();
    }
    // ì†ë°”ë‹¥(íŒŒë€ ì›)
    vizCtx.beginPath(); vizCtx.arc(px,py,12,0,Math.PI*2);
    vizCtx.fillStyle='rgba(127,209,255,0.6)'; vizCtx.fill();
    vizCtx.strokeStyle='#003'; vizCtx.stroke();

    // ì†ë„ â†’ ì—ë„ˆì§€(EMA)
    if(lastPalmX!=null && lastT!=null){
      const dt = Math.max(16, now - lastT); // ms
      const vx = Math.abs(px - lastPalmX) / dt; // px/ms
      const raw = vx * 2600;                   // ìŠ¤ì¼€ì¼
      const riseAlpha = 0.25;  // ìƒìŠ¹ ë°˜ì‘
      const decayRate = 0.86;  // ìì—° ê°ì‡ 

      energyEMA = Math.max(raw, energyEMA*decayRate);
      energyEMA = energyEMA*(1-riseAlpha) + raw*riseAlpha;
      energyOut = Math.min(255, energyEMA);
    }
    lastPalmX = px; lastT = now;

  } else {
    // ì†ì´ í”„ë ˆì„ì—ì„œ ì‚¬ë¼ì§€ë©´ â€œì¦‰ì‹œâ€ ë‚®ì¶¤ + ë²„ë¸” ìŠ¤ë¡œí‹€ ì´ˆê¸°í™”
    energyEMA *= 0.4;               // ë¹ ë¥¸ ê°ì‡ ë¡œ ì”ê´‘ ì œê±°
    energyOut = energyEMA;
    lastPalmX = null; lastT = null;
    lastBubbleAt = performance.now(); // ë°”ë¡œ ì§í›„ í­ë°œ ë°©ì§€

    // (ì˜µì…˜: no hand í‘œì‹œ)
    vizCtx.fillStyle='rgba(0,0,0,.35)';
    vizCtx.fillRect(camViz.width-78,camViz.height-20,68,16);
    vizCtx.fillStyle='#fff';
    vizCtx.fillText('no hand', camViz.width-72, camViz.height-8);
  }

  // ì—ë„ˆì§€ ìˆ«ì
  if(energyText) energyText.textContent = 'energy: ' + Math.round(energyOut);

  // ğŸ‘€ ëˆˆ ì „í™˜ + ê±°í’ˆ(ì—¬ê¸°ì„œë§Œ!)
  const cat = document.getElementById('catFace');
  if (cat){
    if (energyOut > MOTION_TH){
      if (!motionActive){
        cat.src = 'eyesclosed.png';
        motionActive = true;
      }
      // ì„¸ì • ì¤‘ì´ë“  ì•„ë‹ˆë“ , ìŠ¤ë¡œí‹€ë¡œë§Œ ìƒì„± (í­ì£¼/í­ë°œ ë°©ì§€)
      const intensity = Math.min(16, 4 + (energyOut - MOTION_TH)*0.22);
      spawnBubblesThrottled(intensity);
    } else {
      if (motionActive){
        cat.src = 'eyesopened.png';
        motionActive = false;
      }
    }
  }

  // ì§„í–‰ë„ëŠ” ì—¬ê¸°ì„œ í˜¸ì¶œ(ê±°í’ˆì€ tickWashing ì•ˆì—ì„œ ì ˆëŒ€ ìƒì„± X)
  tickWashing(energyOut);
}

    /* ===== Fallback: ì°¨ì˜ìƒ ë°©ì‹ ===== */
    let motionRAF=null, videoEl=null, cvsA=null, ctxA=null, cvsB=null, ctxB=null, lastFrameIsA=true;
    async function setupMotionCaptureFallback(){
      if(!videoEl){
        videoEl=document.createElement('video');
        Object.assign(videoEl,{autoplay:true, playsInline:true, muted:true});
        videoEl.style.display="none"; document.body.appendChild(videoEl);
      }
      if(!cvsA){cvsA=document.createElement('canvas');cvsA.width=96;cvsA.height=72;ctxA=cvsA.getContext('2d',{willReadFrequently:true});}
      if(!cvsB){cvsB=document.createElement('canvas');cvsB.width=96;cvsB.height=72;ctxB=cvsB.getContext('2d',{willReadFrequently:true});}

      let stream;
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:{width:320,height:240},audio:false});
      }catch(err){
        alert('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”!'); return;
      }
      videoEl.srcObject=stream; camPrev.srcObject=stream;

      if(motionRAF) cancelAnimationFrame(motionRAF);
      lastFrameIsA=true;

      const loop=()=>{
        const ctxSrc= lastFrameIsA? ctxA:ctxB;
        const ctxDst= lastFrameIsA? ctxB:ctxA;
        ctxSrc.drawImage(videoEl,0,0,cvsA.width,cvsA.height);

        const src=ctxSrc.getImageData(0,0,cvsA.width,cvsA.height).data;
        const dst=ctxDst.getImageData(0,0,cvsA.width,cvsA.height); const d=dst.data;

        let sum=0,count=0,sumX=0,sumY=0; const thPix=60;
        for(let y=0;y<cvsA.height;y++){
          for(let x=0;x<cvsA.width;x++){
            const i=(y*cvsA.width+x)*4;
            const diff=Math.abs(d[i]-src[i])+Math.abs(d[i+1]-src[i+1])+Math.abs(d[i+2]-src[i+2]);
            sum+=diff; d[i]=src[i]; d[i+1]=src[i+1]; d[i+2]=src[i+2]; d[i+3]=255;
            if(diff>thPix){count++; sumX+=x; sumY+=y;}
          }
        }
        ctxDst.putImageData(dst,0,0);
        lastFrameIsA=!lastFrameIsA;

        const energy=sum/(cvsA.width*cvsA.height*3);
        tickWashing(energy);

        vizCtx.clearRect(0,0,camViz.width,camViz.height);
        if(count>25){
          const cx=(sumX/count)*(camViz.width/cvsA.width);
          const cy=(sumY/count)*(camViz.height/cvsA.height);
          vizCtx.beginPath(); vizCtx.arc(cx,cy,10,0,Math.PI*2);
          vizCtx.fillStyle='rgba(127,209,255,0.7)'; vizCtx.fill();
          vizCtx.lineWidth=2; vizCtx.strokeStyle='#003'; vizCtx.stroke();
        }
        if(energyText) energyText.textContent='energy: '+Math.round(energy);
        motionRAF=requestAnimationFrame(loop);
      };
      loop();
    }

    function stopMotionCapture(){
      if(mpCamera && mpCamera.stop) mpCamera.stop();
      mpCamera=null;
      if(motionRAF) cancelAnimationFrame(motionRAF);
      motionRAF=null;
      if(videoEl && videoEl.srcObject){ videoEl.srcObject.getTracks().forEach(t=>t.stop()); videoEl.srcObject=null; }
      if(camPrev && camPrev.srcObject){ camPrev.srcObject.getTracks().forEach(t=>t.stop()); camPrev.srcObject=null; }
    }

    /* =========================
       ì´ˆê¸° ë°”ì¸ë”©
    ========================= */
    window.addEventListener("DOMContentLoaded",()=>{
      renderRules();
      const sc=document.getElementById("startCat");
      if(sc){ sc.addEventListener("click", showRules); }
    });
  </script>
</body>
</html>